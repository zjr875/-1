<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>圣诞手势互动魔法</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --glass: rgba(255, 255, 255, 0.15);
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Cinzel', serif;
            touch-action: none;
        }

        /* 移动端标题优化 */
        #ui-overlay {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
            width: 90%;
            pointer-events: none;
        }

        h1 {
            font-size: 2.2rem; /* 针对手机缩小 */
            margin: 0;
            background: linear-gradient(to bottom, #fff6ad 0%, var(--gold) 50%, #a67c00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5));
            letter-spacing: 3px;
            white-space: nowrap;
        }

        /* 加载界面 */
        #loading-mask {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--gold);
            transition: opacity 0.8s ease;
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(212, 175, 55, 0.2);
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* 移动端按钮优化 */
        #upload-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .glass-btn {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 40px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 50px; /* 圆角更有现代感 */
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .glass-btn:active { transform: scale(0.95); }

        video { display: none; }
        canvas { display: block; }
    </style>
</head>
<body>

    <div id="loading-mask">
        <div class="loader"></div>
        <p id="status-text">召唤圣诞魔法中...</p >
    </div>

    <div id="ui-overlay">
        <h1>Merry Christmas</h1>
    </div>

    <div id="upload-container">
        <button class="glass-btn" onclick="document.getElementById('fileInput').click()">添加回忆</button>
        <input type="file" id="fileInput" hidden accept="image/*" multiple>
    </div>

    <video id="video" playsinline></video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { HandLandmarker, FilesetResolver } from "mediapipe/tasks-vision";

        const PARTICLE_COUNT = 1000; // 移动端性能折中
        const GOLD_COLOR = new THREE.Color(0xd4af37);
        const RED_COLOR = new THREE.Color(0xff4d4d);
        
        let handLandmarker, video, lastVideoTime = -1;
        let tree, particlesMaterial, composer;
        const ornaments = [];

        // 初始化场景
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 6;

        const renderer = new THREE.WebGLRenderer({ antialias: false }); // 移动端关闭原生抗锯齿以换取性能
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendC